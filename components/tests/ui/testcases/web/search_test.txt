*** Settings ***
Documentation     Tests creation of Projects and Datasets
...               and enabled status of create P/D/S options
...
...               This test requires P/D/I in hierarchy.

Resource          ../config.txt
Resource          ../../resources/web/login.txt
Resource          ../../resources/web/tree.txt
Resource          ../../resources/web/thumbs.txt
Library           DateTime

*** Variables ***

${XpathImage}           xpath=//table[@id='dataTable']//img[@alt='image']
${XpathDataset}         xpath=//table[@id='dataTable']//img[@alt='dataset']
${XpathProject}         xpath=//table[@id='dataTable']//img[@alt='project'] 
${XpathPlate}           xpath=//table[@id='dataTable']//img[@alt='plate']
${XpathTable}           xpath=//table[@id='dataTable']
${XpathTableColumn}     xpath=//table[@id='dataTable']//tr/td[position()=3]
${Search_Query}         test
${Default_Srch_Group}   All Groups
${Table_Header}         Name
${ImplicitDELAY}        2
${DayStartTime}         00:00:00
${DayEndTime}           2014-07-18 00:00:00
${FromDate}             2014-01-15
${FromDateWithTime}     2014-01-15 00:00:00
${EndDate}              2014-07-17
${WrongStartDate}       2014-07-20
${AcquiredDateCol}      4
${NotAnImage}           3
                        
*** Keywords ***

Unselect All Checkboxes
    
    Unselect Checkbox  name
    Unselect Checkbox  description
    Unselect Checkbox  annotation
    Unselect Checkbox  image
    Unselect Checkbox  dataset
    Unselect Checkbox  project
    Unselect Checkbox  plate
    Unselect Checkbox  screen

Select All Checkboxes
    
    Select Checkbox  name
    Select Checkbox  description
    Select Checkbox  annotation
    Select Checkbox  image
    Select Checkbox  dataset
    Select Checkbox  project
    Select Checkbox  plate
    Select Checkbox  screen

Omero Default Search
    
    Input Text  id=id_search_query  ${SEARCH_QUERY}
    Submit Form

For-Loop-In-Range-Acquired       [Arguments]         ${rows}
    : FOR    ${INDEX}    IN RANGE    2    ${rows}
    \    Log    ${INDEX}
    \    ${RANDOM_STRING}   Get Table Cell    ${XpathTable}    ${INDEX}    4
    \    ${time} =       Subtract Date From Date      ${RANDOM_STRING}     ${FromDateWithTime}
    \    Should Be True     ${time}>=0
   
For-Loop-In-Range-Imported       [Arguments]         ${rows}
    : FOR    ${INDEX}    IN RANGE    2    ${rows}
    \    ${RANDOM_STRING}   Get Table Cell    ${XpathTable}    ${INDEX}    3
    \    Run Keyword Unless    "${RANDOM_STRING}" == "${EMPTY}"  Condition Check Imported Date  

Condition Check Imported Date
    ${time} =  Subtract Date From Date  ${RANDOM_STRING}  ${DayEndTime}  
    Should Be True     ${time}<=0

Clear Date Text Field
    Input Text  id=startdateinput   ${EMPTY}
    Input Text  id=enddateinput     ${EMPTY}
    Textfield Value Should be  id=startdateinput  ${EMPTY}
    Textfield Value Should be  id=enddateinput  ${EMPTY}

*** Test Cases ***

Test Default Search Check
    [Documentation]     login,search and Check that you are taken to the search ‘page’/UI with your search query entered into the search field.
    
    User "${USERNAME}" logs in with password "${PASSWORD}"
    Omero Default Search
    Location Should Be  ${SEARCH URL}
    Page Should Contain Textfield  name=query
    Textfield Value Should be  name=query   ${SEARCH_QUERY}
    Wait Until Page Contains Element  id=dataTable  1000
 

Test Check Search Results
    [Documentation]     Check if results are displayed on the centre pane

    Page Should Contain Element     id=dataTable
    Page Should Contain Element     id=center_panel
    Table Header Should Contain     ${XpathTable}  Type
    Table Header Should Contain     ${XpathTable}  Name
    Table Header Should Contain     ${XpathTable}  Imported
    Table Header Should Contain     ${XpathTable}  Group
    Table Header Should Contain     ${XpathTable}  Link
    Table Header Should Contain     ${XpathTable}  Acquired
    Page Should Contain Element     ${XpathPlate}
    Page Should Contain Element     ${XpathDataset}
    Page Should Contain Element     ${XpathProject}
    Page Should Contain Element     ${XpathImage}

    
Test Default Search Selections
	[Documentation]		Check that the objects searched for are Projects, Datasets, Images, Screens, Plates (all checkboxes selected by default).

    Checkbox Should Be Selected  image
    Checkbox Should Be Selected  dataset
    Checkbox Should Be Selected  project
    Checkbox Should Be Selected  plate
    Checkbox Should Be Selected  screen
    Checkbox Should Not Be Selected  name
    Checkbox Should Not Be Selected  description
    Checkbox Should Not Be Selected  annotation
    Click Button  id=search_button
    
Test Additional Search With Selections
	[Documentation]		Checkbox selections for name description and annotation and search again

    Select Checkbox  name    
    Select Checkbox  description    
    Select Checkbox  annotation
    Click Button  id=search_button
    
Test Check Search Date Field
	[Documentation]     Check that no date range has been chosen by default.
    
    Page Should Contain Textfield  id=startdateinput
    Textfield Value Should be  id=startdateinput  ${EMPTY}
    Page Should Contain Textfield  id=enddateinput
    Textfield Value Should be  id=enddateinput  ${EMPTY}

Test Check Search Default Group Selection
	[Documentation]		Check that the default Scope for the search is All Groups

    @{In group}  Get List Items  id=searchGroup
    ${expected_group}  Get Selected List Label  id=searchGroup
    Should Be Equal  ${expected_group}  ${Default_Srch_Group}

Test Check Search Default User Selection
	[Documentation]		Check : user matching the username you are logged in as, e.g user-4 user-4.

    @{DataOwned by}  Get List Items  id=searchByGroupMember--1
    ${expected_user}  Get Selected List Label  id=searchByGroupMember--1
    Should Be Equal  ${expected_user}  ${FULL NAME} 

Test Object Types and Fields

    # Select Image Alone
    Unselect All Checkboxes
    Select Checkbox  image
    Click Button  id=search_button
    Set Selenium Implicit Wait          ${ImplicitDELAY}
    Page Should Contain Element         ${XpathImage}
    Page Should Not Contain Element     ${XpathDataset}
    Page Should Not Contain Element     ${XpathProject}
    Page Should Not Contain Element     ${XpathPlate}

    # Select Dataset Alone
    Unselect All Checkboxes
    Select Checkbox  dataset
    Click Button  id=search_button
    Set Selenium Implicit Wait          ${ImplicitDELAY}
    Page Should Contain Element     ${XpathDataset}
    Page Should Not Contain Element     ${XpathImage}
    Page Should Not Contain Element     ${XpathProject}
    Page Should Not Contain Element     ${XpathPlate}

    # Select Project Alone
    Unselect All Checkboxes
    Select Checkbox  project
    Click Button  id=search_button
    Set Selenium Implicit Wait          ${ImplicitDELAY}
    Page Should Contain Element         ${XpathProject}
    Page Should Not Contain Element     ${XpathDataset}
    Page Should Not Contain Element     ${XpathImage}
    Page Should Not Contain Element     ${XpathPlate}

Test Date Range

    #Check with a From and End date
    Input Text  name=query  ${Search_Query}
    Input Text  id=startdateinput   ${FromDate}
    Input Text  id=enddateinput     ${EndDate} 
    Select All Checkboxes
    Click Button    id=search_button
    Page Should Not Contain         ${XpathTable}
    Set Selenium Implicit Wait      ${ImplicitDELAY}  
    Page Should Contain Element     id=center_panel
    ${rows}=        Get Matching XPath Count    xpath=//table[@id='dataTable']/tbody/tr
    For-Loop-In-Range-Acquired      ${rows}+1
    For-Loop-In-Range-Imported      ${rows}+1
    
    #Check with a From date alone
    Clear Date Text Field
    Input Text  id=startdateinput   ${FromDate}
    Click Button  id=search_button
    Set Selenium Implicit Wait      ${ImplicitDELAY}
    Page Should Contain Element     id=center_panel
    ${rows}=        Get Matching XPath Count    xpath=//table[@id='dataTable']/tbody/tr 
    ${cols}=        Get Matching XPath Count    xpath=//table[@id='dataTable']/tbody/tr/td
    For-Loop-In-Range-Acquired      ${rows}+1

    #Check with a End date alone
    Clear Date Text Field
    Input Text  id=enddateinput     ${EndDate}
    Click Button    id=search_button
    Alert Should Be Present    

    #Check with a From date > End date
    Clear Date Text Field
    Input Text      id=startdateinput    ${WrongStartDate}
    Input Text      id=enddateinput      ${EndDate}
    ${text1}         Get Text        id=startdateinput
    ${text2}         Get Text        id=enddateinput
    Should Be Equal As Strings      ${text1}    ${text2}
    Page Should Contain Element         id=dataTable

Test Close All Browsers
    ${se2lib}=    Get Library Instance    Selenium2Library
    ${time} =       Subtract Date From Date      2014-05-28 12:05:52     2014-05-28 12:05:52
    log     ${FromDate} ${DayStartTime}
    log     ${time}
    Close Browser    
    

    

